#!/usr/bin/python3
# bpkg - A universal package manager for blendOS.

import os
import sys
import yaml
import subprocess
import errno

version = "0.2.0pre"

class colors:
    reset = '\033[0m'
    bold = '\033[01m'
    red = '\033[31m'
    cyan = '\033[36m'
    yellow = '\033[33m'
    white = '\033[39m'

c = colors()

def mkdir_p(newdir):
    try: os.makedirs(newdir)
    except OSError as err:
        # Reraise the error unless it's about an already existing directory 
        if err.errno != errno.EEXIST or not os.path.isdir(newdir): 
            raise

def list_containers():
    print(c.bold + c.cyan + ">> i: " + c.white + "please wait, loading container list" + c.reset)

    container_names_out = subprocess.check_output(['podman', 'ps', '-a', '--no-trunc', '--size', '--format', '{{.Names}}'])
    container_images_out = subprocess.check_output(['podman', 'ps', '-a', '--no-trunc', '--size', '--format', '{{.Image}}'])

    container_names_decoded = container_names_out.decode("utf-8") 
    container_images_decoded = container_images_out.decode("utf-8") 

    container_names = container_names_decoded.split('\n')
    container_images = container_images_decoded.split('\n')

    for i in range(len(container_names) - 1):
        print(container_names[i] + " - " + container_images[i])

def overwrite_config():
    container_names_out = subprocess.check_output(['podman', 'ps', '-a', '--no-trunc', '--size', '--format', '{{.Names}}'])
    container_images_out = subprocess.check_output(['podman', 'ps', '-a', '--no-trunc', '--size', '--format', '{{.Image}}'])

    container_names_decoded = container_names_out.decode("utf-8") 
    container_images_decoded = container_images_out.decode("utf-8") 

    container_names = container_names_decoded.split('\n')
    container_images = container_images_decoded.split('\n')

    if len(container_names) == 0:
        print(c.bold + c.red + ">> e: " + c.white + "no containers found, create some containers first" + c.reset)
        print(c.bold + c.red + ">> e: " + c.white + "no changes will be made" + c.reset)
        sys.exit(-2)
    else:
        confdir = os.path.expanduser('~') + "/.config/"
        confloc = confdir + "bpkg.yaml"
        mkdir_p(confdir)
        conf = open(confloc, "w")
        conf.write("# bpkg config file\n# Auto-generated by bpkg ")
        conf.write(version)
        conf.write("\n\ncontainers:\n")

    for i in range(len(container_names) - 1):
        if container_images[i] == "docker.io/library/archlinux:latest":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("arch\n")
        elif container_images[i] == "docker.io/library/ubuntu:22.04":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("ubuntu-22.04\n")
        elif container_images[i] == "docker.io/library/ubuntu:23.04":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("ubuntu-23.04\n")
        elif container_images[i] == "docker.io/library/fedora:38":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("fedora-38\n")
        elif container_images[i] == "quay.io/almalinux/almalinux:9":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("almalinux-9\n")
        elif container_images[i] == "registry.getcryst.al/crystal/misc/docker:latest":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("crystal-linux\n")
        elif container_images[i] == "docker.io/library/debian:latest":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("debian\n")
        elif container_images[i] == "docker.io/kalilinux/kali-rolling:latest":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("kali-linux\n")
        elif container_images[i] == "docker.io/library/neurodebian:nd120":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("neurodebian-bookworm\n")
        elif container_images[i] == "docker.io/rockylinux/rockylinux:9":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("rocky-linux\n")
        else:
            print(c.bold + c.yellow + ">> w: " + c.white + "invalid distro for container \"" + container_names[i] + "\"" + c.reset)
            print(c.bold + c.yellow + ">> w: " + c.white + "bpkg is most likely out of date or it hasn't been updated for a new container distro yet" + c.reset)
            print(c.bold + c.yellow + ">> w: " + c.white + "skipping distro \"" + container_names[i] + "\"" + c.reset)

    conf.write("\nupdate_flatpak: true\n")
    conf.close()


def pkginstall(package):
    confdir = os.path.expanduser('~') + "/.config/"
    confloc = confdir + "bpkg.yaml"

    conf = open(confloc, "r")
    yamlconf = yaml.safe_load(conf)

    for i in range(len(yamlconf["containers"])):
        if (
            yamlconf["containers"][i]["distro"] == "arch" or 
            yamlconf["containers"][i]["distro"] == "crystal-linux"
        ):

            print(c.bold + c.cyan + ">> i: " + c.white + "checking for package \"" + package + "\" in container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
            pkgcheck = subprocess.run(["sudo", "pacman." + yamlconf["containers"][i]["name"], "-Si", package], stdout = subprocess.DEVNULL, stderr = subprocess.DEVNULL)

            if pkgcheck.returncode == 0:
                print(c.bold + c.cyan + ">> i: " + c.white + "package \"" + package + "\" found in container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
                pkgcheck = subprocess.run(["sudo", "pacman." + yamlconf["containers"][i]["name"], "-S", "--needed", package])
                return pkgcheck.returncode


        elif (
            yamlconf["containers"][i]["distro"] == "ubuntu-22.04" or 
            yamlconf["containers"][i]["distro"] == "ubuntu-23.04" or 
            yamlconf["containers"][i]["distro"] == "debian" or 
            yamlconf["containers"][i]["distro"] == "neurodebian-bookworm" or
            yamlconf["containers"][i]["distro"] == "kali-linux"
            ):

            print(c.bold + c.cyan + ">> i: " + c.white + "checking for package \"" + package + "\" in container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
            pkgcheck = subprocess.run(["sudo", "apt." + yamlconf["containers"][i]["name"], "show", package], stdout = subprocess.DEVNULL, stderr = subprocess.DEVNULL)

            if pkgcheck.returncode == 0:
                print(c.bold + c.cyan + ">> i: " + c.white + "package \"" + package + "\" found in container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
                subprocess.run(["sudo", "apt." + yamlconf["containers"][i]["name"], "update"])
                pkgcheck = subprocess.run(["sudo", "apt." + yamlconf["containers"][i]["name"], "install", package])
                return pkgcheck.returncode

        elif (
            yamlconf["containers"][i]["distro"] == "fedora-38" or 
            yamlconf["containers"][i]["distro"] == "almalinux-9" or
            yamlconf["containers"][i]["distro"] == "rocky-linux"
            ):

            print(c.bold + c.cyan + ">> i: " + c.white + "checking for package \"" + package + "\" in container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
            pkgcheck = subprocess.run(["sudo", "dnf." + yamlconf["containers"][i]["name"], "info", package], stdout = subprocess.DEVNULL, stderr = subprocess.DEVNULL)

            if pkgcheck.returncode == 0:
                print(c.bold + c.cyan + ">> i: " + c.white + "package \"" + package + "\" found in container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
                pkgcheck = subprocess.run(["sudo", "dnf." + yamlconf["containers"][i]["name"], "install", package, "--refresh"])
                return pkgcheck.returncode

        else:

            print(c.bold + c.yellow + ">> w: " + c.white + "invalid distro for container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
            print(c.bold + c.yellow + ">> w: " + c.white + "bpkg is most likely out of date or it hasn't been updated for a new container distro yet" + c.reset)
            print(c.bold + c.yellow + ">> w: " + c.white + "skipping distro \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
        
    print(c.bold + c.red + ">> e: " + c.white + "package \"" + package + "\" not found in your containers" + c.reset)

def pkgremove(package):
    confdir = os.path.expanduser('~') + "/.config/"
    confloc = confdir + "bpkg.yaml"

    conf = open(confloc, "r")
    yamlconf = yaml.safe_load(conf)

    for i in range(len(yamlconf["containers"])):
        if (
            yamlconf["containers"][i]["distro"] == "arch" or 
            yamlconf["containers"][i]["distro"] == "crystal-linux"
        ):

            print(c.bold + c.cyan + ">> i: " + c.white + "checking if package \"" + package + "\" in container \"" + yamlconf["containers"][i]["name"] + "\" is installed" + c.reset)
            pkgcheck = subprocess.run(["sudo", "pacman." + yamlconf["containers"][i]["name"], "-Q", package], stdout = subprocess.DEVNULL, stderr = subprocess.DEVNULL)

            if pkgcheck.returncode == 0:
                print(c.bold + c.cyan + ">> i: " + c.white + "package \"" + package + "\" is installed in container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
                pkgcheck = subprocess.run(["sudo", "pacman." + yamlconf["containers"][i]["name"], "-R", package])
                return pkgcheck.returncode


        elif (
            yamlconf["containers"][i]["distro"] == "ubuntu-22.04" or 
            yamlconf["containers"][i]["distro"] == "ubuntu-23.04" or 
            yamlconf["containers"][i]["distro"] == "debian" or 
            yamlconf["containers"][i]["distro"] == "neurodebian-bookworm" or
            yamlconf["containers"][i]["distro"] == "kali-linux"
            ):

            print(c.bold + c.cyan + ">> i: " + c.white + "checking if package \"" + package + "\" in container \"" + yamlconf["containers"][i]["name"] + "\" is installed" + c.reset)
            is_pkg_installed_out = subprocess.check_output(["sudo", "apt." + yamlconf["containers"][i]["name"], "list", "-qq", package, "--installed"])
            is_pkg_installed_decoded = is_pkg_installed_out.decode("utf-8") 

            if is_pkg_installed_decoded != "":
                print(c.bold + c.cyan + ">> i: " + c.white + "package \"" + package + "\" is installed in container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
                subprocess.run(["sudo", "apt." + yamlconf["containers"][i]["name"], "update"])
                pkgcheck = subprocess.run(["sudo", "apt." + yamlconf["containers"][i]["name"], "remove", package])
                return pkgcheck.returncode

        elif (
            yamlconf["containers"][i]["distro"] == "fedora-38" or 
            yamlconf["containers"][i]["distro"] == "almalinux-9" or
            yamlconf["containers"][i]["distro"] == "rocky-linux"
            ):

            print(c.bold + c.cyan + ">> i: " + c.white + "checking if package \"" + package + "\" in container \"" + yamlconf["containers"][i]["name"] + "\" is installed" + c.reset)
            pkgcheck = subprocess.run(["sudo", "dnf." + yamlconf["containers"][i]["name"], "list", "installed", package], stdout = subprocess.DEVNULL, stderr = subprocess.DEVNULL)

            if pkgcheck.returncode == 0:
                print(c.bold + c.cyan + ">> i: " + c.white + "package \"" + package + "\" is installed in container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
                pkgcheck = subprocess.run(["sudo", "dnf." + yamlconf["containers"][i]["name"], "remove", package])
                return pkgcheck.returncode

        else:

            print(c.bold + c.yellow + ">> w: " + c.white + "invalid distro for container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
            print(c.bold + c.yellow + ">> w: " + c.white + "bpkg is most likely out of date or it hasn't been updated for a new container distro yet" + c.reset)
            print(c.bold + c.yellow + ">> w: " + c.white + "skipping distro \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
        
    print(c.bold + c.red + ">> e: " + c.white + "package \"" + package + "\" is not installed in any of your containers" + c.reset)

def pkgupdate():
    confdir = os.path.expanduser('~') + "/.config/"
    confloc = confdir + "bpkg.yaml"

    conf = open(confloc, "r")
    yamlconf = yaml.safe_load(conf)

    for i in range(len(yamlconf["containers"])):
        if (
            yamlconf["containers"][i]["distro"] == "arch" or 
            yamlconf["containers"][i]["distro"] == "crystal-linux"
        ):

            print(c.bold + c.cyan + ">> i: " + c.white + "updating container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
            subprocess.run(["sudo", "pacman." + yamlconf["containers"][i]["name"], "-Syu", "--noconfirm"])

        elif (
            yamlconf["containers"][i]["distro"] == "ubuntu-22.04" or 
            yamlconf["containers"][i]["distro"] == "ubuntu-23.04" or 
            yamlconf["containers"][i]["distro"] == "debian" or 
            yamlconf["containers"][i]["distro"] == "neurodebian-bookworm" or
            yamlconf["containers"][i]["distro"] == "kali-linux"
            ):

            print(c.bold + c.cyan + ">> i: " + c.white + "updating container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
            subprocess.run(["sudo", "apt." + yamlconf["containers"][i]["name"], "update"])
            subprocess.run(["sudo", "apt." + yamlconf["containers"][i]["name"], "upgrade", "-y"])

        elif (
            yamlconf["containers"][i]["distro"] == "fedora-38" or 
            yamlconf["containers"][i]["distro"] == "almalinux-9" or
            yamlconf["containers"][i]["distro"] == "rocky-linux"
            ):

            print(c.bold + c.cyan + ">> i: " + c.white + "updating container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
            subprocess.run(["sudo", "dnf." + yamlconf["containers"][i]["name"], "update", "-y", "--refresh"])

        else:

            print(c.bold + c.yellow + ">> w: " + c.white + "invalid distro for container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
            print(c.bold + c.yellow + ">> w: " + c.white + "bpkg is most likely out of date or it hasn't been updated for a new container distro yet" + c.reset)
            print(c.bold + c.yellow + ">> w: " + c.white + "skipping distro \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
        
    if yamlconf["update_flatpak"] == True:
        print(c.bold + c.cyan + ">> i: " + c.white + "updating flatpak" + c.reset)
        subprocess.run(["flatpak", "update", "-y"])



def pkgsearch(package):
    confdir = os.path.expanduser('~') + "/.config/"
    confloc = confdir + "bpkg.yaml"

    conf = open(confloc, "r")
    yamlconf = yaml.safe_load(conf)
    isfound = False

    for i in range(len(yamlconf["containers"])):
        if (
            yamlconf["containers"][i]["distro"] == "arch" or 
            yamlconf["containers"][i]["distro"] == "crystal-linux"
        ):

            pkgcheck = subprocess.run(["sudo", "pacman." + yamlconf["containers"][i]["name"], "-Si", package], stdout = subprocess.DEVNULL, stderr = subprocess.DEVNULL)

            if pkgcheck.returncode == 0:
                print(c.bold + c.cyan + ">> i: " + c.white + "package \"" + package + "\" found in container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
                isfound = True


        elif (
            yamlconf["containers"][i]["distro"] == "ubuntu-22.04" or 
            yamlconf["containers"][i]["distro"] == "ubuntu-23.04" or 
            yamlconf["containers"][i]["distro"] == "debian" or 
            yamlconf["containers"][i]["distro"] == "neurodebian-bookworm" or
            yamlconf["containers"][i]["distro"] == "kali-linux"
            ):

            pkgcheck = subprocess.run(["sudo", "apt." + yamlconf["containers"][i]["name"], "show", package], stdout = subprocess.DEVNULL, stderr = subprocess.DEVNULL)

            if pkgcheck.returncode == 0:
                print(c.bold + c.cyan + ">> i: " + c.white + "package \"" + package + "\" found in container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
                isfound = True

        elif (
            yamlconf["containers"][i]["distro"] == "fedora-38" or 
            yamlconf["containers"][i]["distro"] == "almalinux-9" or
            yamlconf["containers"][i]["distro"] == "rocky-linux"
            ):

            pkgcheck = subprocess.run(["sudo", "dnf." + yamlconf["containers"][i]["name"], "info", package], stdout = subprocess.DEVNULL, stderr = subprocess.DEVNULL)

            if pkgcheck.returncode == 0:
                print(c.bold + c.cyan + ">> i: " + c.white + "package \"" + package + "\" found in container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
                isfound = True

        else:

            print(c.bold + c.yellow + ">> w: " + c.white + "invalid distro for container \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)
            print(c.bold + c.yellow + ">> w: " + c.white + "bpkg is most likely out of date or it hasn't been updated for a new container distro yet" + c.reset)
            print(c.bold + c.yellow + ">> w: " + c.white + "skipping distro \"" + yamlconf["containers"][i]["name"] + "\"" + c.reset)

    if isfound == False:
        print(c.bold + c.red + ">> e: " + c.white + "package \"" + package + "\" not found in your containers" + c.reset)


def usage():
    print("Usage:")
    print("bpkg install <package> - Install a package")
    print("bpkg remove <package> - Remove a package")
    print("bpkg update - Update repositories and upgrade packages")
    print("bpkg search <package> - Display which repositories contain the desired package")
    print("bpkg list-containers - List all containers on your system, even the ones not in the config file for bpkg")
    print("bpkg overwrite-config - Overwrites the config file with an autogenerated one")
    print("bpkg help or bpkg usage or bpkg about - Display this message")
    print("You can also input the name of one of your containers\nas the final argument to do operations only to that specific container.")
    print("For more documentation visit https://docs.blendos.co/docs/utilities/bpkg/\n")
    print("About:")
    print("bpkg " + version)
    print("Designed for blendOS\n")
    print("Contributors:")
    print("SvGaming - bpkg lead developer")
    print("Asterisk - bpkg documentation")

def main():
    if os.geteuid() == 0:
        print(c.bold + c.red + ">> e: " + c.white + "must be run as a non-root user, root permissons will be requested if required" + c.reset)
        sys.exit(-1)

    confdir = os.path.expanduser('~') + "/.config/"
    confloc = confdir + "bpkg.yaml"

    if os.path.exists(confloc):
        pass
    else:
        print(c.bold + c.cyan + ">> i: " + c.white + "The bpkg config file located at \"" + confloc + "\" seems to be missing. Generating config..." + c.reset)
        overwrite_config()
        print(c.bold + c.cyan + ">> i: " + c.white + "done, your new config file is located at \"" + confloc + "\"" + c.reset)
        print(c.bold + c.cyan + ">> i: " + c.white + "a config file editing guide is available at https://docs.blendos.co/docs/utilities/bpkg#configuration" + c.reset)
    if len(sys.argv) < 2:
        print(c.bold + c.red + ">> e: " + c.white + "insufficient arguments" + c.reset)
        usage()
        sys.exit(1)
    
    if sys.argv[1] == "update":
        pkgupdate()
    elif sys.argv[1] == "search":
        for i in range(2, len(sys.argv)):
            pkgsearch(sys.argv[i])
    elif sys.argv[1] == "help" or sys.argv[1] == "usage" or sys.argv[1] == "about":
        usage()
    elif sys.argv[1] == "overwrite-config":
        print(c.bold + c.cyan + ">> i: " + c.white + "overwriting old config file with an autogenerated one" + c.reset)
        overwrite_config()
        print(c.bold + c.cyan + ">> i: " + c.white + "done, your new config file is located at \"" + confloc + "\"" + c.reset)
        print(c.bold + c.cyan + ">> i: " + c.white + "a config file editing guide is available at https://docs.blendos.co/docs/utilities/bpkg#configuration" + c.reset)
    elif sys.argv[1] == "list-containers":
        list_containers()
    else: 
        if len(sys.argv) < 3:
            print(c.bold + c.red + ">> e: " + c.white + "insufficient arguments for this operation or invalid operation" + c.reset)
            usage()
            sys.exit(1)
        if sys.argv[1] == "install":
            for i in range(2, len(sys.argv)):
                exitcode = pkginstall(sys.argv[i])
            sys.exit(exitcode)
        elif sys.argv[1] == "remove":
            for i in range(2, len(sys.argv)):
                exitcode = pkgremove(sys.argv[i])
            sys.exit(exitcode)
        else:
            print(c.bold + c.red + ">> e: " + c.white + "invalid operation" + c.reset)
            usage()
            sys.exit(1)
    


if __name__ == '__main__':
    main()
