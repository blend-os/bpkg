#!/usr/bin/python3
# bpkg - A blendOS tool similar to the VanillaOS "apx" tool
# Created by SvGaming, 2023

import os
import sys
import yaml
import subprocess
import errno
from io import StringIO

version = "0.2.0pre"

def mkdir_p(newdir):
    try: os.makedirs(newdir)
    except OSError as err:
        # Reraise the error unless it's about an already existing directory 
        if err.errno != errno.EEXIST or not os.path.isdir(newdir): 
            raise

def overwrite_config():
    container_names_out = subprocess.check_output(['podman', 'ps', '-a', '--no-trunc', '--size', '--format', '{{.Names}}'])
    container_images_out = subprocess.check_output(['podman', 'ps', '-a', '--no-trunc', '--size', '--format', '{{.Image}}'])

    container_names_decoded = container_names_out.decode("utf-8") 
    container_images_decoded = container_images_out.decode("utf-8") 

    container_names = container_names_decoded.split('\n')
    container_images = container_images_decoded.split('\n')

    if len(container_names) == 0:
        print("\033[1m\033[31m>> e: \033[39mno containers found, create some containers first\033[0m")
        print("\033[1m\033[31m>> e: \033[39mno changes will be made\033[0m")
        sys.exit(-2)
    else:
        confdir = os.path.expanduser('~') + "/.config/"
        confloc = confdir + "bpkg.yaml"
        mkdir_p(confdir)
        conf = open(confloc, "w")
        conf.write("# bpkg config file\n# Auto-generated by bpkg ")
        conf.write(version)
        conf.write("\n\ncontainers:\n")
    for i in range(len(container_names) - 1):
        if container_images[i] == "docker.io/library/archlinux:latest":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("arch\n")
        elif container_images[i] == "docker.io/library/ubuntu:22.04":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("ubuntu-22.04\n")
        elif container_images[i] == "docker.io/library/ubuntu:23.04":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("ubuntu-23.04\n")
        elif container_images[i] == "docker.io/library/fedora:38":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("fedora-38\n")
        elif container_images[i] == "quay.io/almalinux/almalinux:9":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("almalinux-9\n")
        elif container_images[i] == "registry.getcryst.al/crystal/misc/docker:latest":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("crystal-linux\n")
        elif container_images[i] == "docker.io/library/debian:latest":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("debian\n")
        elif container_images[i] == "docker.io/kalilinux/kali-rolling:latest":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("kali-linux\n")
        elif container_images[i] == "docker.io/library/neurodebian:nd120":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("neurodebian-bookworm\n")
        elif container_images[i] == "docker.io/rockylinux/rockylinux:9":
            conf.write("  - name: ")
            conf.write(container_names[i])
            conf.write("\n    distro: ")
            conf.write("rocky-linux\n")
        else:
            print("\033[1m\033[33m>> w: \033[39minvalid distro for container \"" + container_names[i] + "\"\033[0m")
            print("\033[1m\033[33m>> w: \033[39mbpkg is most likely out of date or it hasn't been updated for a new container distro yet\033[0m")
            print("\033[1m\033[33m>> w: \033[39mskipping distro \"" + container_names[i] + "\"\033[0m")

    conf.write("\nupdate_flatpak: true\n")
    conf.close()


def pkginstall():
    print("install placeholder")

def pkgremove():
    print("remove placeholder")

def pkgupdate():
    confdir = os.path.expanduser('~') + "/.config/"
    confloc = confdir + "bpkg.yaml"

    conf = open(confloc, "r")
    yamlconf = yaml.safe_load(conf)

    for i in range(len(yamlconf["containers"])):
        if yamlconf["containers"][i]["distro"] == "arch" or yamlconf["containers"][i]["distro"] == "crystal-linux":
            print("\033[1m\033[36m>> i: \033[39mupdating container \"" + yamlconf["containers"][i]["name"] + "\"\033[0m")
            subprocess.run(["sudo", "pacman." + yamlconf["containers"][i]["name"], "-Syu", "--noconfirm"])

        elif (yamlconf["containers"][i]["distro"] == "ubuntu-22.04" or yamlconf["containers"][i]["distro"] == "ubuntu-23.04" or 
            yamlconf["containers"][i]["distro"] == "debian" or yamlconf["containers"][i]["distro"] == "neurodebian-bookworm"
            or yamlconf["containers"][i]["distro"] == "kali-linux"):
            print("\033[1m\033[36m>> i: \033[39mupdating container \"" + yamlconf["containers"][i]["name"] + "\"\033[0m")
            subprocess.run(["sudo", "apt." + yamlconf["containers"][i]["name"], "update"])
            subprocess.run(["sudo", "apt." + yamlconf["containers"][i]["name"], "upgrade", "-y"])

        elif (yamlconf["containers"][i]["distro"] == "fedora-38" or yamlconf["containers"][i]["distro"] == "almalinux-9" or
            yamlconf["containers"][i]["distro"] == "rocky-linux"):
            print("\033[1m\033[36m>> i: \033[39mupdating container \"" + yamlconf["containers"][i]["name"] + "\"\033[0m")
            subprocess.run(["sudo", "dnf." + yamlconf["containers"][i]["name"], "update", "-y", "--refresh"])

        else:
            print("\033[1m\033[33m>> w: \033[39minvalid distro for container \"" + yamlconf["containers"][i]["name"] + "\"\033[0m")
            print("\033[1m\033[33m>> w: \033[39mbpkg is most likely out of date or it hasn't been updated for a new container distro yet\033[0m")
            print("\033[1m\033[33m>> w: \033[39mskipping distro \"", yamlconf["containers"][i]["name"], "\"\033[0m")
        
    if yamlconf["update_flatpak"] == True:
        print("\033[1m\033[36m>> i: \033[39mupdating flatpak\033[0m")
        subprocess.run(["flatpak", "update", "-y"])



def pkgsearch():
    print("search placeholder")

def usage():
    print("Usage:\nplaceholder\nAbout: bpkg by SvGaming for blendOS")

def main():
    if os.geteuid() == 0:
        print("\033[1m\033[31m>> e: \033[39must be run as a non-root user, root permissons will be requested if required\033[0m")
        sys.exit(-1)

    confdir = os.path.expanduser('~') + "/.config/"
    confloc = confdir + "bpkg.yaml"

    if os.path.exists(confloc):
        pass
    else:
        print("\033[1m\033[36m>> i: \033[39mThe bpkg config file located at \"" + confloc + "\" seems to be missing. Generating config...\033[0m")
        overwrite_config()
        print("\033[1m\033[36m>> i: \033[39mdone, your new config file is located at \"" + confloc + "\"\033[0m")
    if len(sys.argv) < 2:
        print("\033[1m\033[31m>> e: \033[39minsufficient arguments\033[0m")
        usage()
        sys.exit(1)
    
    if sys.argv[1] == "update":
        pkgupdate()
    elif sys.argv[1] == "search":
        pkgsearch()
    elif sys.argv[1] == "overwrite-config":
        print("\033[1m\033[36m>> i: \033[39moverwriting old config file with an autogenerated one\033[0m")
        conf.close()
        overwrite_config()
        print("\033[1m\033[36m>> i: \033[39mdone, your new config file is located at \"" + confloc + "\"\033[0m")
    else: 
        if len(sys.argv) < 3:
            print("\033[1m\033[31m>> e: \033[39minsufficient arguments for this operation or invalid operation\033[0m")
            usage()
            sys.exit(1)
        if sys.argv[1] == "install":
            pkginstall()
        elif sys.argv[1] == "remove":
            pkginstall()
        else:
            print("\033[1m\033[31m>> e: \033[39minvalid operation\033[0m")
            usage()
            sys.exit(1)
    


if __name__ == '__main__':
    main()
